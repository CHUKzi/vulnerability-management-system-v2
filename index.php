<?php session_start();
 require_once('includes/connection.php');
 require_once('includes/functions.php');

$email = '';
$msg = '';
$lock_msg = '';

if (isset($_SESSION["btn_locked"]))
{
	$locked_time = time() - $_SESSION["btn_locked"];
	if ($locked_time > 10)
	{
		unset($_SESSION["btn_locked"]);
		unset($_SESSION["login_try"]);
	}
}
if (empty($_SESSION["login_try"])){
	$_SESSION["login_try"] = '0';
}
  if (isset($_POST['submit'])) 
  {
    // check if there are any errors in the form
    if (empty($errors)) {
      // save username and password into variables
      $email    = mysqli_real_escape_string($connection, $_POST['email']);
      $password   = mysqli_real_escape_string($connection, $_POST['password']);
      $hashed_password = sha1($password);
      // prepare database query
      $query = "SELECT * FROM user WHERE email = '{$email}' AND password = '{$hashed_password}' AND is_deleted=0 LIMIT 1";
      $result_set = mysqli_query($connection, $query);

      $query = "SELECT * FROM user WHERE email = '{$email}' AND password = '{$hashed_password}' AND is_deleted=1 LIMIT 1";
      $result_deleted = mysqli_query($connection, $query);

      if (mysqli_num_rows($result_deleted) == 1) {
      	$msg = '<br><p style="color:red;text-align: center;">This account has been deleted</p>';}

      else if ($result_set) {
        // query succesfful
        if (mysqli_num_rows($result_set) == 1) {
          // valid user found
          $user = mysqli_fetch_assoc($result_set);
          $_SESSION['user_id'] = $user['id'];
          $_SESSION['first_name'] = $user['first_name'];
          $_SESSION['user_admin'] = $user['user_or_admin'];
          // updating last login
          $query = "UPDATE user SET last_login = NOW() WHERE id = {$_SESSION['user_id']} LIMIT 1";
          
          $result_set = mysqli_query($connection, $query);

		  $query = "UPDATE user SET login = 1 WHERE id = {$_SESSION['user_id']} LIMIT 1";
		  $result = mysqli_query($connection, $query);
          // redirect to home-page.php
          header('Location: HOME');
        } else {
        	$_SESSION["login_try"] += 1;
        	$errors = 'Invalid Username / Password';}
      } 
	  else {
	  	$_SESSION["login_try"] += 1;
	  	$errors= 'Database query failed';}
    }
  }
?>
<!DOCTYPE html>
<html lang="en">
<head>
	<title>Web Vulnerability Assessment Management System</title>
	
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="theme-color" content="#3e454c">
	<?php if ($_SESSION["login_try"] > 2) { $_SESSION["btn_locked"] = time();?><meta http-equiv="refresh" content="11"><?php } ?>

	<link rel="icon" type="image/png" class="LogoMain" href="assets/images/LogoIcon.png"/>
	<link rel="stylesheet" type="text/css" href="fonts/Linearicons-Free-v1.0.0/icon-font.min.css">
	<link rel="stylesheet" type="text/css" href="css/LP/util.css">
	<link rel="stylesheet" type="text/css" href="css/LP/main.css">
</head>
<body>
	<div class="limiter">
		<div class="container-login" style="background-image: url('assets/images/CP EC.jpg');">
			<div class="wrap-login p-t-30 p-b-50">
				<span class="login-form-logo">
					<img src="assets/images/Logo.png">
				</span>
				<form class="login-form validate-form p-b-33 p-t-5" action="index.php" method="post">
					<div class="wrap-input validate-input" data-validate = "Enter your e-mail">
						<input class="input" type="text" name="email" value="<?php echo $email;?>" placeholder="Email">
						<span class="focus-input" data-placeholder="&#xe82a;"></span>
					</div>

					<div class="wrap-input validate-input" data-validate="Enter password">
						<input class="input" type="password" name="password" placeholder="Password">
						<span class="focus-input" data-placeholder="&#xe80f;"></span>
					</div>
					<?php
					if ($_SESSION["login_try"] > 2) {
						$_SESSION["btn_locked"] = time();
						//echo '<br><p style="color:red;text-align: center;">wait 10 sec</p>';
						$lock_msg = '<br><p style="color:red;text-align: center;">Please wait <span id="time">00:10</span> and try again</p>';
					} else {?>
					<div class="container-login-form-btn m-t-32">
						<button class="login-form-btn" type="submit" name="submit">Login</button>
					</div>
					<?php } ?>
		        <?php 
		          if (isset($errors) && !empty($errors) && empty($lock_msg)) {
		          		echo '<br><p style="color:red;text-align: center;">Invalid Email or Password</p>';
		          } else {
		          	echo $lock_msg;
		          }
		        ?>
		        <?php 

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 1){
							echo '<br><p style="color:red;text-align: center;">Please login to continue</p>';
						}
					}

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 2){
							echo '<br><p style="color:red;text-align: center;">Your account has been deleted</p>';
						}
					}

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 3){
							echo '<br><p style="color:green;text-align: center;">You are successfully logged out</p>';
							session_destroy();
						}
					}

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 4){
							header('Location: HOME');
						}
					}

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 5){
							echo '<br><p style="color:red;text-align: center;">You are NOT logged in</p>';
						}
					}

					if(isset($_GET['log_out']))
					{
						$code=$_GET['log_out'];
						if($code == 6){
							
							echo '<br><p style="color:red;text-align: center;">Session Expired</p>';
						}
					}

					echo $msg;
		        ?>
				</form>
			</div>
		</div>
	</div>
		
	<script src="assets/js/login/main.js"></script>
	<script>
	function startTimer(duration, display) {
	    var timer = duration, minutes, seconds;
	    setInterval(function () {
	        minutes = parseInt(timer / 60, 10);
	        seconds = parseInt(timer % 60, 10);

	        minutes = minutes < 10 ? "0" + minutes : minutes;
	        seconds = seconds < 10 ? "0" + seconds : seconds;

	        display.textContent = minutes + ":" + seconds;

	        if (--timer < 0) {
	            timer = duration;
	        }
	    }, 1000);
	}
	window.onload = function () {
	    var fiveMinutes = 9,
	        display = document.querySelector('#time');
	    startTimer(fiveMinutes, display);
	};
	</script>

</body>
</html>

<?php mysqli_close($connection); ?>